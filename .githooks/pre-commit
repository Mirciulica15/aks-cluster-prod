#!/usr/bin/env bash

set -euo pipefail

echo "ğŸ”ƒ Running Gitleaks on files in . ..."
gitleaks dir -v --config gitleaks.toml

GITLEAKS_RESULT=$?
if [ $GITLEAKS_RESULT -ne 0 ]; then
    echo "âŒ Gitleaks found issues. Commit aborted."
    exit 1
fi

echo "âœ… Gitleaks passed."

echo "ğŸ”ƒ Running Tflint on .tf files in ./infrastructure ..."
tflint --chdir=infrastructure/

TFLINT_RESULT=$?
if [ $TFLINT_RESULT -ne 0 ]; then
    echo "âŒ Tflint found issues. Commit aborted."
    exit 1
fi

echo "âœ… Tflint passed."

echo "ğŸ”ƒ Running Checkov on .tf files in ./infrastructure ..."
checkov --framework terraform -d infrastructure

CHECKOV_RESULT=$?
if [ $CHECKOV_RESULT -ne 0 ]; then
    echo "âŒ Checkov found issues. Commit aborted."
    exit 1
fi

echo "âœ… Checkov passed."

echo "ğŸ”ƒ Formatting Terraform configuration ..."
terraform fmt -recursive infrastructure/
echo "âœ… Formatting completed."

echo "ğŸ”ƒ Moving to infrastructure/ directory ..."
cd infrastructure/ || exit 1

CD_INFRASTRUCTURE_RESULT=$?
if [ $CD_INFRASTRUCTURE_RESULT -ne 0 ]; then
    echo "âŒ Failed to change directory to infrastructure. Commit aborted."
    exit 1
fi

echo "âœ… Successfully moved to infrastructure/ directory."

echo "ğŸ”ƒ Running Terraform init ..."
terraform init -upgrade

TERRAFORM_INIT_RESULT=$?
if [ $TERRAFORM_INIT_RESULT -ne 0 ]; then
    echo "âŒ Terraform init failed. Commit aborted."
    exit 1
fi

echo "âœ… Terraform init completed."

echo "ğŸ”ƒ Running Terraform validate ..."
terraform validate

TERRAFORM_VALIDATE_RESULT=$?
if [ $TERRAFORM_VALIDATE_RESULT -ne 0 ]; then
    echo "âŒ Terraform validate failed. Commit aborted."
    exit 1
fi

echo "âœ… Terraform validate passed."

echo "ğŸ”ƒ Running Infracost to check cost forecast ..."
json_output=$(infracost breakdown --path . --format json)
total=$(jq -r '.totalMonthlyCost' <<<"$json_output")
if ! [[ $total =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
    echo "âŒ Error: totalMonthlyCost is not a valid number: '$total'" >&2
    exit 1
fi

if awk "BEGIN { exit !($total > 400) }"; then
    echo "âŒ Error: totalMonthlyCost ($total) exceeds 100" >&2
    exit 1
fi

echo "âœ… Infracost completed. Cost forecast is within the limits, totalMonthlyCost is $total"

echo "ğŸ”ƒ Moving back to root directory ..."
cd .. || exit 1

CD_ROOT_RESULT=$?
if [ $CD_ROOT_RESULT -ne 0 ]; then
    echo "âŒ Failed to change directory to root. Commit aborted."
    exit 1
fi

echo "âœ… Successfully moved back to root directory."

echo "ğŸ”ƒ Staging changed files ..."
git add .

GIT_ADD_RESULT=$?
if [ $GIT_ADD_RESULT -ne 0 ]; then
    echo "âŒ Git add failed. Commit aborted."
    exit 1
fi

echo "âœ… Staging completed."

echo "âœ… Proceeding with commit."

exit 0
